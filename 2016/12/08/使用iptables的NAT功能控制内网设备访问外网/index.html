<html><head><meta name="generator" content="Hexo 3.9.0"><title>使用iptables的NAT功能控制内网设备访问外网</title><meta name="keywords" content="KDF5000, OpenHex"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link href="/css/main.css?v=3" rel="stylesheet" type="text/css"><script src="/js/util.js"></script><script>isMobile()?loadjscssfile("../css/mobile.css","css"):loadjscssfile("../css/desktop.css","css")</script><link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=3"></head><body><h2 class="title">使用iptables的NAT功能控制内网设备访问外网</h2><ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#前提条件"><span class="toc-text">前提条件</span></a></li></ol><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤"><span class="toc-text">步骤</span></a><p>通过iptables的NAT功能控制内网上网。</p><h5 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h5><p>一台能够上网的主机，并且和其他需要控制上网的主机在同一个内网。</p><p>hw98: 172.18.11.98 可以上外网</p><p>hw网段: 172.18.11.0/24</p><p>目的：通过hw98装发内网内的其他机器数据包，从而实现上网控制的目的</p><h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><p>hw98设置路由转发的功能</p><ul><li><p>开启内核的ip转发功能</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">或者</span><br><span class="line"><span class="meta">$</span> vim /etc/sysctl.conf</span><br><span class="line"><span class="meta">#</span> Controls IP packet forwarding</span><br><span class="line">net.ipv4.ip_forward = 1</span><br></pre></td></tr></table></figure></li><li><p>添加确认包和关联包的通过</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br></pre></td></tr></table></figure></li></ul><a id="more"></a><ul><li><p>设置iptables的nat表，添加FORWARD规则</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> iptables -t nat -A POSTROUTING -s 172.18.11.0/24 -j SNAT --to 172.18.11.98</span><br></pre></td></tr></table></figure></li></ul><p>内网内需要进行上网的机器</p><ul><li><p>删除默认的路由，如果没有就不用删除</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span>route del default gw *.*.*.*  #通过route 查看</span><br></pre></td></tr></table></figure></li><li><p>添加hw98为默认路由</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span>route add default gw 172.18.11.98</span><br></pre></td></tr></table></figure></li></ul><p>上面内网的设置在重启网络的时候会被修改，所以最好的方法就是在网络配置里就行设置，在centos就是<code>/etc/sysconfig/network-scripts/ifcfg-eth0</code>，只用设置GATEWAY即可，如果有必要也可以设置一下DNS</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GATEWAY=172.18.11.98</span><br><span class="line">DNS1=159.226.39.1</span><br></pre></td></tr></table></figure><p><strong>说明：</strong>没有深入理解整个运行过程，其实可以通过hw98的iptables设置进行更加细致的访问控制，比如控制内网内特定的主机访问外网，这里是全部允许，也可以控制特定的端口等等。</p><div style="display:none"><script src="http://s4.cnzz.com/stat.php?id=undefined&web_id=undefined" language="JavaScript"></script>script></div><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></li></body></html>