<html><head><meta name="generator" content="Hexo 3.9.0"><title>auditd的使用</title><meta name="keywords" content="KDF5000, OpenHex"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link href="/css/main.css?v=3" rel="stylesheet" type="text/css"><script src="/js/util.js"></script><script>isMobile()?loadjscssfile("../css/mobile.css","css"):loadjscssfile("../css/desktop.css","css")</script><link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=3"></head><body><h2 class="title">auditd的使用</h2><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装"><span class="toc-text">安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#添加auditd规则"><span class="toc-text">添加auditd规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看审计日志"><span class="toc-text">查看审计日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看审计报告"><span class="toc-text">查看审计报告</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#auditd配置文件"><span class="toc-text">auditd配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol><p>linux系统中用户空间的组件，负责系统安全审计，将审计的记录写入磁盘</p><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>ubuntu可以直接使用apt-get安装，centos使用yum安装</p><p>安装后有下面相关的工具：</p><ul><li><strong>auditctl :</strong> 即时控制审计守护进程的行为的工具，比如如添加规则等等。</li><li><strong>/etc/audit/audit.rules :</strong> 记录审计规则的文件。</li><li><strong>aureport :</strong> 查看和生成审计报告的工具。</li><li><strong>ausearch :</strong> 查找审计事件的工具</li><li><strong>auditspd :</strong> 转发事件通知给其他应用程序，而不是写入到审计日志文件中。</li><li><strong>autrace :</strong> 一个用于跟踪进程的命令。</li><li><strong>/etc/audit/auditd.conf :</strong> auditd工具的配置文件。</li></ul><p>首次安装auditd后，审计规则是空的，使用下面的命令查看</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span>auditctl -l</span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="添加auditd规则"><a href="#添加auditd规则" class="headerlink" title="添加auditd规则"></a>添加auditd规则</h4><p>监控文件和目录的更改</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span>sudo auditctl -w /etc/passwd -p rwxa</span><br></pre></td></tr></table></figure><p>选项：</p><ul><li>-w path: 指定监控的路径，上面指定监控的文件路径/etc/passwd</li><li>-p: 指定出发审计的文件/目录的访问权限</li><li>rwxa: 指定的触发条件，r读，w写，x执行权限，a属性</li></ul><p>如果不加-p参数，-w参数后面指定的是目录，则将会对指定目录所有访问进行监控。默认的权限是rwax，可以使用<code>auditctl -l</code>查看已经添加的规则</p><p><img src="/images/archive/blog/image/auditd-0.png" alt></p><h4 id="查看审计日志"><a href="#查看审计日志" class="headerlink" title="查看审计日志"></a>查看审计日志</h4><p>使用ausearch可以查看auditd的审计日志。比如上面已经对/etc/passwd文件添加了审计，那么使用下面的命令可以查看审计日志。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span>sudo ausearch - f/etc/passwd</span><br></pre></td></tr></table></figure><p><code>-f</code>需要查找的审计目标的日志</p><p>输出可能如下</p><blockquote><hr><p>time-&gt;Wed Sep 21 15:07:51 2016<br>type=PATH msg=audit(1474441671.907:881): item=1 name=”/root/kongdefei/.test.swp” inode=44826697 dev=08:03 mode=0100600 ouid=0 ogid=0 rdev=00:00<br>type=PATH msg=audit(1474441671.907:881): item=0 name=”/root/kongdefei/“ inode=80856866 dev=08:03 mode=040755 ouid=0 ogid=0 rdev=00:00<br>type=CWD msg=audit(1474441671.907:881): cwd=”/root/kongdefei”<br>type=SYSCALL msg=audit(1474441671.907:881): arch=c000003e syscall=87 success=yes exit=0 a0=699f130 a1=1 a2=1 a3=2 items=2 ppid=18763 pid=18798 auid=4294967295 uid=0 gid=0 euid=0 s<br>uid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=pts1 ses=4294967295 comm=”vi” exe=”/bin/vi” key=(null)</p></blockquote><ul><li>time: 审计时间</li><li>name: 审计对象</li><li>cwd: 当前路径</li><li>sys call：系统调用</li><li>auid: 设计用户id</li><li>uid和gid：访问文件的用户id和用户组id,uid=0 gid=0表明是root用户</li><li>comm: 用户访问文件的命令</li><li>exe: 上面命令的执行文件路径</li></ul><p>上面内容表示/root/kongdefei/.test.swp文件被root用户使用vi命令编辑过</p><h4 id="查看审计报告"><a href="#查看审计报告" class="headerlink" title="查看审计报告"></a>查看审计报告</h4><p>一旦定义规则后，他会自动运行，过一段时间后，可以使用auditd的工具aureport生成简要的日志报告。直接使用下面命令即可</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span>sudo aureport</span><br></pre></td></tr></table></figure><p> <img src="/images/archive/blog/image/auditd-1.png" alt></p><p>可以看出有51次授权失败，102次登录。可以使用下面命令查看授权失败的详细信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span>sudo aureport -au</span><br></pre></td></tr></table></figure><p> <img src="/images/archive/blog/image/auditd-4.png" alt></p><p>凡是no（如2，5）的都是授权失败。可以看出是root用户ssh登录的时候失败。</p><p><code>-m</code>可以查看所有账户修改相关的事件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span>sudo aureport -m</span><br></pre></td></tr></table></figure><p> <img src="/images/archive/blog/image/auditd-2.png" alt></p><h4 id="auditd配置文件"><a href="#auditd配置文件" class="headerlink" title="auditd配置文件"></a>auditd配置文件</h4><p>上面使用-w添加审计规则只是暂时的，系统重启后就会消失，可以修改/etc/audit/audit.rules文件是规则持久有效。上面添加的规则可以直接写入/etc/audit/audit.rules文件中</p><p>如下：</p><p> <img src="/images/archive/blog/image/auditd-3.png" alt></p><p>然后重启auditd即可</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> service auditd restart #或者/etc/init.d/auditd restart</span><br></pre></td></tr></table></figure><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>Auditd是Linux上的一个审计工具。你可以阅读auidtd文档获取更多使用auditd和工具的细节。例如，输入 <strong>man auditd</strong> 去看auditd的详细说明，或者键入 <strong>man ausearch</strong> 去看有关 ausearch 工具的详细说明。</p><p><strong>请谨慎创建规则</strong>。太多规则会使得日志文件急剧增大！</p><div style="display:none"><script src="http://s4.cnzz.com/stat.php?id=undefined&web_id=undefined" language="JavaScript"></script>script></div><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>